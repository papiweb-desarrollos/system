<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Videos del Sistema Solar - Papiweb</title>
    
    <!-- Favicons para m√°xima compatibilidad -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon_16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon_32x32.png') }}">
    <link rel="icon" type="image/png" sizes="64x64" href="{{ url_for('static', filename='favicon_64x64.png') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(rgba(12, 12, 43, 0.4), rgba(26, 26, 74, 0.4), rgba(45, 45, 90, 0.4)),
                        url('{{ url_for("static", filename="obser.png") }}') center/cover no-repeat fixed;
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(15px);
        }

        .header h1 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .header a {
            color: #ffd700 !important;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .header a:hover {
            color: #ffed4e !important;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            transform: scale(1.05);
        }

        .coffee-icon {
            display: inline-block;
            margin: 0 5px;
            font-size: 1.2em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h2 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ccc;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 16px;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Estilos espec√≠ficos para el men√∫ desplegable */
        .form-group select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='%23ffffff' viewBox='0 0 16 16'%3e%3cpath d='m7.247 4.86-4.796 5.481c-.566.647-.106 1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 0 0 0-1.506 0z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-group select option {
            background-color: #1a1a4a;
            color: white;
            padding: 8px 12px;
            border: none;
        }

        .form-group select option:hover,
        .form-group select option:focus {
            background-color: #2d2d5a;
            color: #ffd700;
        }

        .form-group select option:checked {
            background-color: #ffd700;
            color: #000;
        }

        .form-group select optgroup {
            background-color: #0c0c2b;
            color: #ffd700;
            font-weight: bold;
            font-style: normal;
            padding: 5px 10px;
        }

        .form-group select optgroup option {
            background-color: #1a1a4a;
            color: white;
            padding-left: 20px;
            font-weight: normal;
        }

        /* Mejoras adicionales para la visibilidad del men√∫ */
        .form-group select {
            max-height: none;
        }

        .form-group select[size] {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Forzar estilos del navegador para opciones */
        select option {
            background-color: #1a1a4a !important;
            color: white !important;
        }

        select option:hover {
            background-color: #2d2d5a !important;
            color: #ffd700 !important;
        }

        select optgroup {
            background-color: #0c0c2b !important;
            color: #ffd700 !important;
            font-weight: bold !important;
        }

        .btn {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
        }

        .status.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            transition: width 0.3s ease;
            width: 0%;
        }

        .videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .video-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .video-card:hover {
            transform: translateY(-5px);
        }

        .video-card h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }

        .video-card video {
            width: 100%;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
        }

        .video-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .video-container:fullscreen {
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-container:fullscreen video {
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
        }

        .video-container:-webkit-full-screen {
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-container:-webkit-full-screen video {
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
        }

        .video-container:-moz-full-screen {
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-container:-moz-full-screen video {
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
        }

        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 5;
        }

        .video-loading .spinner {
            margin: 0 auto 10px;
        }

        .video-loading p {
            margin: 0;
            font-size: 14px;
        }

        .video-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin: 5px 0;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffd700;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            opacity: 0.7;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="coffee-icon">‚òï</span> Papiweb Desarrollos Inform√°ticos</h1>
            <p>Generador de Videos del Sistema Solar</p>
            <p><strong><a href="https://link.mercadopago.com.ar/papiweb" target="_blank" style="color: #ffd700; text-decoration: none;">link.mercadopago.com.ar/papiweb</a></strong></p>
        </div>

        <div class="main-content">
            <!-- Panel de Generaci√≥n -->
            <div class="panel">
                <h2>üöÄ Generar Nuevo Video</h2>
                <form id="videoForm">
                    <div class="form-group">
                        <label for="mode">Modo de Visualizaci√≥n:</label>
                        <select id="mode" name="mode">
                            <optgroup label="üåç Modos B√°sicos">
                                <option value="basic">B√°sico - Sistema solar simple</option>
                                <option value="minimal">M√≠nimal - Solo planetas sin etiquetas</option>
                                <option value="clean">Limpio - Vista simplificada</option>
                            </optgroup>
                            <optgroup label="üé® Efectos Visuales">
                                <option value="detailed">Detallado - Con efectos de trazas</option>
                                <option value="glow">Brillo - Planetas con halo luminoso</option>
                                <option value="trails">Trazas - Estelas de movimiento</option>
                            </optgroup>
                            <optgroup label="‚≠ê Efectos Espaciales">
                                <option value="stars">Estrellas - Campo de estrellas brillantes</option>
                                <option value="nebula">Nebulosa - Fondo de nebulosa colorida</option>
                                <option value="deep_space">Espacio Profundo - Vista c√≥smica</option>
                                <option value="night_sky">Cielo Nocturno - Vista terrestre</option>
                            </optgroup>
                            <optgroup label="üåå Objetos C√≥smicos">
                                <option value="asteroids">Asteroides - Cintur√≥n de asteroides</option>
                                <option value="comets">Cometas - Cometas con colas</option>
                                <option value="meteor_shower">Lluvia de Meteoros - Meteoritos cruzando</option>
                                <option value="satellites">Sat√©lites - Lunas de planetas</option>
                            </optgroup>
                            <optgroup label="‚òÄÔ∏è Efectos Solares">
                                <option value="solar_flares">Llamaradas Solares - Erupciones del Sol</option>
                            </optgroup>
                            <optgroup label="üé• Modos de C√°mara">
                                <option value="orbits">√ìrbitas - Muestra las √≥rbitas planetarias</option>
                                <option value="zoom">Zoom - Acercamiento a planetas</option>
                                <option value="zoom_pause">Zoom con Pausa - Zoom lento con pausas</option>
                                <option value="planet_focus">Enfoque Planetario - Sigue planetas</option>
                                <option value="spaceship">Nave Espacial - Viaje entre planetas</option>
                            </optgroup>
                            <optgroup label="üåü Modos Especiales">
                                <option value="realistic">Realista - Simulaci√≥n precisa</option>
                                <option value="cosmic">C√≥smico - Efectos espaciales avanzados</option>
                                <option value="all">Completo - Todos los efectos b√°sicos</option>
                                <option value="all_effects">Ultra Completo - TODOS los efectos</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="seconds">Duraci√≥n (segundos):</label>
                        <input type="number" id="seconds" name="seconds" min="1" max="120" value="10">
                    </div>

                    <div class="form-group">
                        <label for="fps">Frames por segundo:</label>
                        <input type="number" id="fps" name="fps" min="5" max="60" value="15">
                    </div>

                    <div class="form-group">
                        <label for="quality">Calidad del Video:</label>
                        <select id="quality" name="quality">
                            <option value="low">Baja (800x600) - R√°pida</option>
                            <option value="medium" selected>Media (1400x1000) - Balanceada</option>
                            <option value="high">Alta (1920x1080) - Mejor calidad</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="speed">Velocidad de Animaci√≥n:</label>
                        <select id="speed" name="speed">
                            <option value="0.5">Muy Lenta (0.5x)</option>
                            <option value="0.8">Lenta (0.8x)</option>
                            <option value="1.0" selected>Normal (1.0x)</option>
                            <option value="1.5">R√°pida (1.5x)</option>
                            <option value="2.0">Muy R√°pida (2.0x)</option>
                            <option value="3.0">Ultra R√°pida (3.0x)</option>
                        </select>
                    </div>

                    <button type="submit" class="btn" id="generateBtn">
                        üé¨ Generar Video
                    </button>
                </form>

                <div id="status" class="status" style="display: none;"></div>
                <div class="progress-bar" id="progressContainer" style="display: none;">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
            </div>

            <!-- Panel de Videos -->
            <div class="panel">
                <h2>üé• Videos Generados</h2>
                <button class="btn" onclick="loadVideos()" style="margin-bottom: 20px;">
                    üîÑ Actualizar Lista
                </button>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Cargando videos...</p>
                </div>

                <div id="videosList" class="videos-grid"></div>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2025 Papiweb Desarrollos Inform√°ticos - Generador de Videos del Sistema Solar</p>
        </div>
    </div>

    <script>
        let statusCheckInterval;

        // Cargar videos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadVideos();
        });

        // Manejar env√≠o del formulario
        document.getElementById('videoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateVideo();
        });

        async function generateVideo() {
            const formData = new FormData(document.getElementById('videoForm'));
            const data = {
                mode: formData.get('mode'),
                seconds: parseInt(formData.get('seconds')),
                fps: parseInt(formData.get('fps')),
                quality: formData.get('quality'),
                speed: parseFloat(formData.get('speed')),
                output: `solar_${formData.get('mode')}_${Date.now()}.mp4`
            };

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('success', `Generaci√≥n iniciada: ${result.mode} (${result.quality}) - ${result.seconds}s @ ${result.fps}fps @ ${result.speed}x`);
                    document.getElementById('generateBtn').disabled = true;
                    document.getElementById('progressContainer').style.display = 'block';
                    
                    // Iniciar monitoreo del estado
                    statusCheckInterval = setInterval(checkStatus, 1000);
                } else {
                    showStatus('error', result.error);
                }
            } catch (error) {
                showStatus('error', 'Error de conexi√≥n: ' + error.message);
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                document.getElementById('progressBar').style.width = status.progress + '%';

                if (!status.running) {
                    clearInterval(statusCheckInterval);
                    document.getElementById('generateBtn').disabled = false;
                    document.getElementById('progressContainer').style.display = 'none';

                    if (status.error) {
                        showStatus('error', 'Error: ' + status.error);
                    } else if (status.progress === 100) {
                        showStatus('success', status.message);
                        setTimeout(loadVideos, 2000); // Recargar videos despu√©s de 2 segundos
                    }
                } else {
                    showStatus('info', status.message + ` (${status.progress}%)`);
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        async function loadVideos() {
            const loading = document.getElementById('loading');
            const videosList = document.getElementById('videosList');
            
            loading.classList.add('show');
            videosList.innerHTML = '';

            try {
                const response = await fetch('/api/videos');
                const videos = await response.json();

                if (videos.length === 0) {
                    videosList.innerHTML = '<p style="text-align: center; opacity: 0.7;">No hay videos disponibles. ¬°Genera tu primer video!</p>';
                } else {
                    videos.forEach(video => {
                        const videoCard = createVideoCard(video);
                        videosList.appendChild(videoCard);
                    });
                }
            } catch (error) {
                videosList.innerHTML = '<p style="text-align: center; color: #f44336;">Error cargando videos: ' + error.message + '</p>';
            } finally {
                loading.classList.remove('show');
            }
        }

        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'video-card';
            
            const sizeInKB = (video.size / 1024).toFixed(1);
            const videoName = video.filename.replace(/\.(mp4|avi)$/, '').replace(/[_-]/g, ' ');
            
            // Determinar el tipo de video para el elemento source
            const videoType = video.filename.endsWith('.mp4') ? 'video/mp4' : 'video/x-msvideo';
            
            // Debug: mostrar la URL en consola
            console.log(`Cargando video: ${video.filename}, URL: ${video.url}, Tipo: ${videoType}`);
            
            card.innerHTML = `
                <h3>${videoName}</h3>
                <div class="video-container">
                    <video 
                        controls 
                        preload="metadata" 
                        style="width: 100%; height: auto; border-radius: 8px;"
                        controlsList="nodownload"
                        onclick="toggleFullscreen(this)"
                        oncontextmenu="return false;"
                        onloadstart="handleVideoLoad(this)"
                        onerror="handleVideoError(this)"
                        oncanplay="handleVideoCanPlay(this)"
                        onloadedmetadata="handleVideoLoadedMetadata(this)">
                        <source src="${video.url}" type="video/mp4">
                        <source src="${video.url}" type="${videoType}">
                        Tu navegador no soporta el elemento video.
                    </video>
                    <button class="fullscreen-btn" onclick="toggleFullscreen(this.previousElementSibling)" title="Pantalla Completa">
                        ‚õ∂
                    </button>
                    <div class="video-loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>Cargando video...</p>
                    </div>
                </div>
                <div class="video-info">üìÅ ${video.filename}</div>
                <div class="video-info">üìä ${sizeInKB} KB</div>
                <div class="video-info">üïí ${video.created}</div>
                <div class="video-info">üîó <a href="${video.url}" target="_blank" style="color: #ffd700;">Enlace directo</a></div>
                <button class="btn" onclick="downloadVideo('${video.url}', '${video.filename}')" style="margin-top: 10px;">
                    üíæ Descargar
                </button>
            `;
            
            return card;
        }

        function downloadVideo(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function toggleFullscreen(videoElement) {
            const container = videoElement.parentElement;
            
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
                // Entrar en pantalla completa
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) {
                    container.webkitRequestFullscreen();
                } else if (container.mozRequestFullScreen) {
                    container.mozRequestFullScreen();
                } else if (container.msRequestFullscreen) {
                    container.msRequestFullscreen();
                }
                
                // Reproducir video autom√°ticamente en pantalla completa
                videoElement.play().catch(e => console.log('Error al reproducir:', e));
                
            } else {
                // Salir de pantalla completa
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // Manejar tecla Escape para salir de pantalla completa
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement)) {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                }
            }
        });

        function handleVideoLoad(video) {
            const container = video.parentElement;
            const loader = container.querySelector('.video-loading');
            if (loader) {
                loader.style.display = 'block';
            }
        }

        function handleVideoCanPlay(video) {
            const container = video.parentElement;
            const loader = container.querySelector('.video-loading');
            if (loader) {
                loader.style.display = 'none';
            }
            video.style.display = 'block';
            console.log(`Video listo para reproducir: ${video.currentSrc}`);
        }

        function handleVideoLoadedMetadata(video) {
            console.log(`Metadatos cargados para: ${video.currentSrc}`);
            console.log(`Duraci√≥n: ${video.duration}s, Dimensiones: ${video.videoWidth}x${video.videoHeight}`);
        }

        function handleVideoError(video) {
            const container = video.parentElement;
            const loader = container.querySelector('.video-loading');
            if (loader) {
                loader.style.display = 'none';
            }
            
            console.error(`Error cargando video: ${video.currentSrc || 'URL no disponible'}`);
            console.error(`C√≥digo de error: ${video.error ? video.error.code : 'Desconocido'}`);
            
            // Crear mensaje de error
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                background: rgba(244, 67, 54, 0.2);
                border: 1px solid #f44336;
                border-radius: 8px;
                padding: 15px;
                text-align: center;
                color: #f44336;
                margin: 10px 0;
            `;
            errorDiv.innerHTML = `
                <strong>‚ö†Ô∏è Error al cargar el video</strong><br>
                <small>El archivo puede estar corrupto o en un formato no compatible</small><br>
                <small>URL: ${video.currentSrc || 'No disponible'}</small>
            `;
            
            // Reemplazar el video con el mensaje de error
            video.style.display = 'none';
            container.appendChild(errorDiv);
        }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }
    </script>
</body>
</html>
